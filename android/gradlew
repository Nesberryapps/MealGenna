#!/usr/bin/env sh

#
# Copyright 2015 the original author or authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

# Add default JVM options here. You can also use JAVA_OPTS and GRADLE_OPTS to pass JVM options to this script.
DEFAULT_JVM_OPTS=""

APP_NAME="Gradle"
APP_BASE_NAME=`basename "$0"`

# Use the maximum available path length for directory names
# on Windows, to avoid common "path too long" issues.
if [ -z "$CYGWIN" ] && [ -z "$DARWIN" ] && [ -z "$MSYS" ] ; then
  if [ -n "$CLASSPATH" ] ; then
    # On other operating systems, and with an existing CLASSPATH,
    # we want to avoid any CLASSPATH problems.
    # We set a new CLASSPATH, but we also include the old one.
    CLASSPATH_SUFFIX=":$CLASSPATH"
  fi
  CLASSPATH_SEPARATOR=":"
fi

# Add extension that may be needed to execute the java command
EXE_EXT=""
if [ -n "$CYGWIN" ] || [ -n "$MSYS" ] ; then
  EXE_EXT=".exe"
fi

# Attempt to set APP_HOME
# Resolve links: $0 may be a link
PRG="$0"
# Need this for relative symlinks.
while [ -h "$PRG" ] ; do
  ls=`ls -ld "$PRG"`
  link=`expr "$ls" : '.*-> \(.*\)$'`
  if expr "$link" : '/.*' > /dev/null; then
    PRG="$link"
  else
    PRG=`dirname "$PRG"`"/$link"
  fi
done
SAVED="`pwd`"
cd "`dirname \"$PRG\"`/" >/dev/null
APP_HOME="`pwd -P`"
cd "$SAVED" >/dev/null

# Attempt to set JAVA_HOME if not already set
if [ -z "$JAVA_HOME" ] ; then
  # If 'java' is in PATH, we will find it
  if [ -x "$(command -v java)" ] ; then
    # resolve symlinks to java
    java_symlink="$(command -v java)"
    while [ -h "$java_symlink" ] ; do
      ls=`ls -ld "$java_symlink"`
      link=`expr "$ls" : '.*-> \(.*\)$'`
      if expr "$link" : '/.*' > /dev/null; then
        java_symlink="$link"
      else
        java_symlink=`dirname "$java_symlink"`"/$link"
      fi
    done
    java_path="$(dirname "$java_symlink")"
    # if we are in the JRE, go one level up
    if [ "x$java_path" = "x/jre/bin" ] ; then
      java_path=$(dirname "$java_path")
    fi
    # if we are in the bin, go one level up
    if [ "x$(basename "$java_path")" = "xbin" ] ; then
      java_path=$(dirname "$java_path")
    fi
    JAVA_HOME="$java_path"
  fi
fi

# For Cygwin, ensure paths are in UNIX format before anything is touched
if [ -n "$CYGWIN" ] ; then
  [ -n "$APP_HOME" ] &&
    APP_HOME=`cygpath --unix "$APP_HOME"`
  [ -n "$JAVA_HOME" ] &&
    JAVA_HOME=`cygpath --unix "$JAVA_HOME"`
  [ -n "$CLASSPATH" ] &&
    CLASSPATH=`cygpath --path --unix "$CLASSPATH"`
fi

# For MSYS, ensure paths are in UNIX format before anything is touched
if [ -n "$MSYS" ] ; then
  [ -n "$APP_HOME" ] &&
    APP_HOME="`(cd \"$APP_HOME\" && pwd)`"
  [ -n "$JAVA_HOME" ] &&
    JAVA_HOME="`(cd \"$JAVA_HOME\" && pwd)`"
  # TODO - CLASSPATH conversion
fi

# For Darwin, add options to specify how the application appears in the dock
if [ -n "$DARWIN" ] ; then
  GRADLE_OPTS="$GRADLE_OPTS \"-Xdock:name=$APP_NAME\" \"-Xdock:icon=$APP_HOME/media/gradle.icns\""
fi

# Verify that GRADLE_HOME is not set
if [ ! -z "$GRADLE_HOME" ] ; then
  echo "GRADLE_HOME is not supported. Please use the gradle wrapper instead." 1>&2
  exit 1
fi

# Collect all arguments for the java command, stacking in order:
#
# 1. system properties from gradle.properties
# 2. DEFAULT_JVM_OPTS from this script
# 3. JAVA_OPTS from the environment
# 4. GRADLE_OPTS from the environment
#
# Collect all arguments for the gradle command, stacking in order:
#
# 1. GRADLE_ARGS from the environment
# 2. command-line arguments
#

# For Cygwin or MSYS, switch paths to Windows format before running java
if [ -n "$CYGWIN" ] || [ -n "$MSYS" ] ; then
  [ -n "$APP_HOME" ] &&
    APP_HOME=`cygpath --path --windows "$APP_HOME"`
  [ -n "$JAVA_HOME" ] &&
    JAVA_HOME=`cygpath --path --windows "$JAVA_HOME"`
fi

# Define the location of the gradle-wrapper.jar file
GRADLE_WRAPPER_JAR="$APP_HOME/gradle/wrapper/gradle-wrapper.jar"

# Read system properties from gradle.properties
#
# This logic is aiming to reflect the behavior of the regular 'gradle'
# command-line script. We can't know for sure whether the user has a
# project-specific gradle.properties, but we can look for a project-
# specific gradlew. It is a safe bet that if a project has a gradlew,
# it will also have a gradle.properties.
#
# In that case, we want to use the settings in that file. If we can't
# find a project-specific gradle.properties, we will look for one in
# the user's home directory.
if [ -f "$APP_HOME/gradlew" ] && [ -f "$APP_HOME/gradle.properties" ] ; then
  PROPERTIES_FILE="$APP_HOME/gradle.properties"
elif [ -f "$HOME/.gradle/gradle.properties" ] ; then
  PROPERTIES_FILE="$HOME/.gradle/gradle.properties"
fi
if [ -f "$PROPERTIES_FILE" ] ; then
  GRADLE_PROPERTIES_OPTS=`sed -e '/^\s*#/d' -e '/^\s*$/d' -e 's/^\s*systemProp\.//' -e 's/=\(.*\)/="-D\0"/' -e "s/'/\\\\\'/g" "$PROPERTIES_FILE"`
  eval "set -- $GRADLE_PROPERTIES_OPTS"
  while [ $# -gt 0 ]
  do
    GRADLE_OPTS="$GRADLE_OPTS $1"
    shift
  done
fi

# Use JAVA_HOME if available, otherwise use 'java'
if [ -n "$JAVA_HOME" ] ; then
  if [ -x "$JAVA_HOME/jre/sh/java" ] ; then
    # IBM's JDK on AIX uses strange locations for the executables
    JAVACMD="$JAVA_HOME/jre/sh/java"
  else
    JAVACMD="$JAVA_HOME/bin/java"
  fi
  if [ ! -x "$JAVACMD" ] ; then
    die "ERROR: JAVA_HOME is set to an invalid directory: $JAVA_HOME

Please set the JAVA_HOME variable in your environment to match the
location of your Java installation."
  fi
else
  JAVACMD="java"
  which java >/dev/null 2>&1 || die "ERROR: JAVA_HOME is not set and no 'java' command could be found in your PATH.

Please set the JAVA_HOME variable in your environment to match the
location of your Java installation."
fi

# Set JAVACMD to be the Java executable.
JAVACMD="$JAVACMD$EXE_EXT"

# Build the JAVA_OPTS variable from all sources
# (including GRADLE_OPTS, which is not strictly a Java option)
ALL_JAVA_OPTS="$DEFAULT_JVM_OPTS $JAVA_OPTS $GRADLE_OPTS"

# Prepend `java` command with `cygpath` if needed
if [ -n "$CYGWIN" ] && [ "$OS" != "Windows_NT" ] ; then
  # On Cygwin, we want to use the Java command with the Windows path,
  # rather than the Cygwin path.
  JAVACMD=`cygpath --path --windows "$JAVACMD"`
fi

# Build the command to run
#
# We want to avoid using 'eval' since it can be problematic with
# command-line arguments that contain spaces. We have to jump through
# some hoops to get the quoting right. We are trying to build a command
# that looks like:
#
#   "java" <jvm_args> -classpath "..." <main_class> <args>
#
# The `CLASSPATH_SEPARATOR` is used to separate classpath elements.
#
# The `"` quotes are used to handle paths with spaces, but they need to
# be escaped, so they become `\"`. We want to avoid using `\` on the
# command-line when we can, because that can be interpreted by the shell.
#
# The 'x' is used to avoid empty arguments.
#
# The `"$@"` are the command-line arguments, which should be passed-through
# as-is. This is the whole reason for this mess.
#
# It is important that this script be executed with 'sh' and not 'bash',
# because 'bash' would interpret the `\` escapes differently.
#
xCLASSPATH="-classpath"
xCLASSPATH="$xCLASSPATH$CLASSPATH_SEPARATOR\"$GRADLE_WRAPPER_JAR\""
xMAINCLASS="org.gradle.wrapper.GradleWrapperMain"

# Add all the command-line arguments to the `GRADLE_ARGS` variable
GRADLE_ARGS="$GRADLE_ARGS \"$@\""

# Some environments (e.g. Jenkins) don't have a proper tty, which causes
# the Gradle output to be non-colored. Let's force it.
if [ -t 1 ] ; then
  GRADLE_ARGS="$GRADLE_ARGS -Dorg.gradle.color.all=true"
fi

# The following is replacement for usage of 'eval' that is problematic with some shells.
#
# It is important to note that this does not attempt to address all possible quoting
# concerns, but rather is designed to address the most common cases.
#
# This is adapted from the `batik` script, which is licensed under the Apache
# license, version 2.0.
#
# In general, the `\ ` sequence is not supported by this script.
#
# A simplified illustration of the problem is as follows:
#
# Normal /bin/sh behavior:
#
#   $ sh -c 'echo "a b"'
#   a b
#   $ sh -c 'echo "a\ b"'
#   a\ b
#
# With `eval`:
#
#   $ eval 'echo "a b"'
#   a b
#   $ eval 'echo "a\ b"'
#   ab
#
# The `eval` removes one level of `\` escapes.
#
# This can be handled by adding extra `\` escapes, but that is clumsy.
#
# A better approach is to build up the command-line in an array.
#
# The following is a verbose, but straightforward, way of doing this.
#
CMD_LINE_ARGS=""
for arg in $ALL_JAVA_OPTS; do
  # Add quotes if the argument contains spaces.
  case "$arg" in
    *" "* )
      arg="\"$arg\""
      ;;
  esac
  CMD_LINE_ARGS="$CMD_LINE_ARGS $arg"
done

CMD_LINE_ARGS="$CMD_LINE_ARGS $xCLASSPATH $xMAINCLASS"

for arg in "$@" ; do
  # Add quotes if the argument contains spaces.
  case "$arg" in
    *" "* )
      arg="\"$arg\""
      ;;
  esac
  CMD_LINE_ARGS="$CMD_LINE_ARGS $arg"
done

# Run the command
exec "$JAVACMD" $CMD_LINE_ARGS
